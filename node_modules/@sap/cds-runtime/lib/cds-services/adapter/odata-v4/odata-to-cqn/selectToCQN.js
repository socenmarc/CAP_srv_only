const { isSameArray } = require('./utils')

const _isAssocOrComposition = (entity, col) => {
  return entity.elements[col].type === 'cds.Association' || entity.elements[col].type === 'cds.Composition'
}

/**
 * Add odata select to a CQN object.
 *
 * @param {string} select - odata select string
 * @param {array} keys - array of primary keys
 * @param {object} entity - csn entity targeted by the request
 * @private
 */
const selectToCQN = (select, keys, entity) => {
  const elements = []
  const columns = select.split(',').map(e => e.split('/'))
  if (columns.some(col => col[0] === '*')) {
    return []
  }

  for (const col of columns) {
    if (!_isAssocOrComposition(entity, col[0])) {
      elements.push({ ref: col })
    }
  }

  for (const key of keys) {
    // add key, as odata-v4 always expects the key here.
    const newRef = { ref: [key] }
    if (key && !elements.some(ref => isSameArray(ref.ref, newRef.ref))) {
      elements.push(newRef)
    }
  }

  for (const col of Object.keys(entity.elements)) {
    const newRef = { ref: [col] }
    if (entity.elements[col]['@odata.etag'] && !elements.some(ref => isSameArray(ref.ref, newRef.ref))) {
      elements.push(newRef)
    }
  }

  return Array.from(elements)
}

module.exports = selectToCQN
