function _convertOrderBy (element, orderByEntry) {
  const foreignKey = orderByEntry.ref.join('_')
  for (const key of element.keys) {
    if (`${element.name}_${key.ref[0]}` === foreignKey) {
      orderByEntry.ref = [foreignKey]
    }
  }
}

const _handler = req => {
  // do simple checks upfront and exit early
  if (!req.query || typeof req.query === 'string') return
  if (!req.query.SELECT.orderBy) return

  const target = req.target || req.context.target
  if (!target) return

  for (const orderByEntry of req.query.SELECT.orderBy) {
    if (!orderByEntry.ref || orderByEntry.ref.length !== 2) {
      // only check refs in format {ref: ['assoc', 'id']}
      continue
    }

    const element = target.elements[orderByEntry.ref[0]]
    if (!element || !element.is2one) return

    _convertOrderBy(element, orderByEntry)
  }
}

_handler._initial = true

module.exports = _handler
