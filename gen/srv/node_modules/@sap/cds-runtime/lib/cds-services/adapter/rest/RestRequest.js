const cds = global.cds || require('@sap/cds/lib')

const MODEL = Symbol.for('sap.cds.model')

const restToCqn = require('./rest-to-cqn')
const { flattenDeepToOneAssociations } = require('../../services/utils/handlerUtils')
const negotiateLocale = require('../utils/locale')

/*
 * Class representing a REST request.
 * @extends Request
 *
 * @param {String} parsed - The parsed url of the incoming request
 * @param {Object} data - A deep copy of the request payload
 * @param {Object} restReq - express' req
 * @param {Object} restRes - express' res
 * @param {Object} service - The underlying CAP service
 */
class RestRequest extends cds.Request {
  constructor (parsed, data, restReq, restRes, service) { // NOSONAR
    const _ = { req: restReq, res: restRes }

    const { event, target } = parsed

    /*
     * query
     */
    const query = restToCqn(parsed, data, restReq)

    /*
     * user
     */
    const user = _.req.user || new cds.User()

    /*
     * method, params, headers
     */
    const { method, params, headers } = restReq
    // REVISIT: 'x-cds-incoming-protocol' workaround to find out in outgoing rest/messaging if custom headers were provided
    headers['x-cds-incoming-protocol'] = 'rest'

    /*
     * super
     */
    super({ event, target, data, query, user, method, params, headers, _, _model: service.model })

    // REVISIT: overwrite user.locale getter in order to consider locale via query options, etc.
    Object.defineProperty(user, 'locale', {
      get () {
        return this._locale || (this._locale = negotiateLocale(_, service.options && service.options.defaultLocale))
      },
      configurable: true
    })

    // REVISIT: validate associations for deep insert
    flattenDeepToOneAssociations(this, this.model)

    /*
     * req.run
     */
    Object.defineProperty(this, 'run', {
      configurable: true,
      get: () => (...args) => cds.tx(this).run(...args)
    })

    // REVISIT: streamline ref to model
    this[MODEL] = service.model

    // REVISIT: context.statements to be removed (cf. https://github.wdf.sap.corp/cap/matters/issues/837)
    this.statements = cds.ql

    if (this._.req.performanceMeasurement) {
      this.performanceMeasurement = this._.req.performanceMeasurement
    }
    if (this._.req.dynatrace) {
      this.dynatrace = this._.req.dynatrace
    }
  }
}

module.exports = RestRequest
