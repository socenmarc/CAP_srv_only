const cdsc = require ('./_cdsc'), {_options} = cdsc
const minified = require ('../alpha/_skip_unused')
const {unfold_ddl} = require ('../alpha/_localized')


function cds_compile_to_sql (csn,o) {
  const all = cdsc.to.sql (minified(csn),o=_options(o))
  const sql = unfold_ddl (all.map (each => each
    .replace(/^-- .+\n/,'')  //> strip comments
    .replace(/;$/,'')        //> strip semicola
  ), csn, o)
  if (o.as === 'str') return `\n${sql.join(';\n\n')}\n`
  return sql
}


function cds_compile_to_hdbtable (csn,o) {
  const all = cdsc.to.hdi (minified(csn),_options(o))
  return _2many(all)
}


function cds_compile_to_hdbcds (csn,o) {
  const all = cdsc.to.hdbcds (minified(csn),_options(o))
  return _2many(all, f => f.replace(/\./g,'_').replace('_hdbcds','.hdbcds'))
}

function* _2many (all,_file=f=>f) {
  for (let file in all) yield [
    all[file].replace(/^(\/\/|--) generated by .+\n/,''),
    { file:_file(file) }
  ]
}

module.exports = Object.assign (cds_compile_to_sql, {
  hdbcds: cds_compile_to_hdbcds,
  hdbtable: cds_compile_to_hdbtable,
})
